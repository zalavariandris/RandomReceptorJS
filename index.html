<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/102/three.js"></script>
        <style type="text/css">
            #viewport{
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            #info{
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                text-align: center;
                width: auto;
            }
            h1{
                color: cyan;
                font-family: courier;
                text-shadow: 1px 1px 0px deeppink;
                font-size: 12px;
            }

            video#webcam{
                display: none;
            }
            #viewport{
                display: block;
            }
        </style>
    </head>
    <body>
        <video id="webcam" playsinline controls="true" autoplay></video>

        <div id="viewport"></div>
        <div id="info">
            <h1>RandomReceptor</h1>
        </div>
        <script id="vs" type="x-shader/x-vertex">
            varying vec2 vUv;

            void main() {
              vUv = uv; 

              gl_Position =   projectionMatrix * 
                        modelViewMatrix * 
                        vec4(position,1.0); 
            }
        </script>
        <script id="fs" type="x-shader/x-fragment">
            uniform sampler2D texture1;
            uniform sampler2D mask;
            varying vec2 vUv;

            void main() {
                vec4 texColor = texture2D(texture1, vUv);
                vec4 maskColor = texture2D(mask, vUv);
                gl_FragColor = vec4(texColor.rgb, maskColor.r);
            }
        </script>

        <script type="text/javascript">
            var camera, renderer, video;
            var maskScene, maskFbo;
            var videoScene, videoFbo;
            var mainScene;

            init();
            animate();

            window.onresize = function(e){
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function init(){
                // Grab Webcam
                video = document.getElementById( 'webcam' );

                if ( navigator.mediaDevices && navigator.mediaDevices.getUserMedia ) {
                    var constraints = { video: { width: 1280, height: 720, facingMode: 'user' } };
                    navigator.mediaDevices.getUserMedia( constraints ).then( function ( stream ) {
                        // apply the stream to the video element used in the texture
                        video.srcObject = stream;
                        video.play();
                    } ).catch( function ( error ) {
                        console.error( 'Unable to access the camera/webcam.', error );
                    } );
                } else {
                    console.error( 'MediaDevices interface not available.' );
                }

                // The Camera
                camera = new THREE.OrthographicCamera( -0.5, 0.5, -0.5, 0.5, -1000, 1000 );

                // The Renderer
                renderer = new THREE.WebGLRenderer( {  preserveDrawingBuffer: true } );
                renderer.setSize( window.innerWidth, window.innerHeight );
                renderer.autoClear = false;

                // add canvas to document
                var viewport = document.getElementById( 'viewport' );
                viewport.appendChild( renderer.domElement );

                // Construct Video Scene      
                videoScene = new THREE.Scene();
                videoScene.add( new THREE.Mesh( 
                    new THREE.PlaneGeometry(), 
                    new THREE.MeshBasicMaterial( { 
                        map: new THREE.VideoTexture( video ), 
                        color:"white",
                        side: THREE.DoubleSide
                    } )
                ) );
                videoFbo = new THREE.WebGLRenderTarget(500, 500);

                // Construct Mask Scene
                maskScene = new THREE.Scene();
                for(var i=0; i< 1000; i++){
                    maskMesh = new THREE.Mesh(
                        new THREE.CircleBufferGeometry(0.01,8),
                        new THREE.MeshBasicMaterial( { 
                            color:"white",
                            side: THREE.DoubleSide
                        })
                    );
                    maskMesh.position.set(Math.random()-0.5, Math.random()-0.5, 0);
                    maskScene.add(maskMesh);
                }
                maskFbo = new THREE.WebGLRenderTarget(500, 500);

                // Construct Main Scene
                mainScene = new THREE.Scene();
                mainScene.add(new THREE.Mesh(
                    new THREE.PlaneGeometry(), 
                    new THREE.ShaderMaterial( {
                        uniforms: {
                            texture1: { type: "t", value: videoFbo.texture },
                            mask: { type: "t", value: maskFbo.texture }
                        }, 
                        vertexShader: document.getElementById( 'vs' ).textContent, 
                        fragmentShader: document.getElementById( 'fs' ).textContent,
                        side: THREE.DoubleSide,
                        transparent: true
                    } )
                ));
            }

            function animate(){
                // main loop
                requestAnimationFrame( animate );

                // Animate Mask Scene
                for(var child of maskScene.children){
                    child.position.set(Math.random()-0.5, Math.random()-0.5, 0);
                }

                // Render to mask fbo
                renderer.setRenderTarget(maskFbo);
                renderer.clear();
                renderer.render(maskScene, camera);

                // Render to video fbo
                renderer.setRenderTarget(videoFbo);
                renderer.render(videoScene, camera);

                // Render main scene
                renderer.setRenderTarget(null);
                renderer.render(mainScene, camera);
            }
        </script>
    </body>
</html>